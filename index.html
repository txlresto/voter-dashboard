<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Demographics Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            font-weight: 500;
            background: linear-gradient(135deg, #8b1538 0%, #4a1625 100%);
            background-attachment: fixed;
            color: #1a202c;
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
        }
        
        @media (min-width: 768px) {
            .container { padding: 2rem; }
        }
        
        .header {
            margin-bottom: 2rem;
        }
        
        @media (min-width: 768px) {
            .header { margin-bottom: 3rem; }
        }
        
        .title {
            font-size: 2rem;
            font-weight: 800;
            background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 1rem;
            border-radius: 16px;
            border: 2px solid transparent;
            letter-spacing: -0.02em;
        }
        
        @media (min-width: 768px) {
            .title { font-size: 3rem; }
        }
        
        .title:hover {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-color: rgba(255,255,255,0.2);
        }
        
        .title-input {
            font-size: 2rem;
            font-weight: 800;
            color: #1a202c;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            border: 2px solid #667eea;
            border-radius: 16px;
            padding: 1rem;
            text-align: center;
            width: 100%;
            margin-bottom: 1rem;
            letter-spacing: -0.02em;
        }
        
        @media (min-width: 768px) {
            .title-input { font-size: 3rem; }
        }
        
        .title-input:focus {
            outline: none;
            border-color: #8b1538;
            box-shadow: 0 0 0 4px rgba(139, 21, 56, 0.1);
        }
        
        .title-edit-hint {
            font-size: 0.875rem;
            color: rgba(255,255,255,0.8);
            text-align: center;
            margin-top: 0.5rem;
            font-weight: 400;
        }
        
        .upload-section {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            padding: 1.5rem;
            border-radius: 24px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        @media (min-width: 768px) {
            .upload-section { padding: 2rem; }
        }
        
        .upload-controls {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        @media (min-width: 768px) {
            .upload-controls { gap: 1rem; }
        }
        
        .upload-btn, .btn {
            background: linear-gradient(135deg, #8b1538 0%, #4a1625 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 16px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 10px 20px rgba(139, 21, 56, 0.3);
            text-decoration: none;
            display: inline-block;
        }
        
        @media (min-width: 768px) {
            .upload-btn, .btn { 
                padding: 1rem 2rem; 
                font-size: 0.9rem; 
            }
        }
        
        .upload-btn:hover, .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(139, 21, 56, 0.4);
        }
        
        .btn-blue {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            box-shadow: 0 10px 20px rgba(79, 172, 254, 0.3);
        }
        
        .btn-blue:hover {
            box-shadow: 0 15px 30px rgba(79, 172, 254, 0.4);
        }
        
        .btn-red {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            box-shadow: 0 10px 20px rgba(240, 147, 251, 0.3);
        }
        
        .btn-red:hover {
            box-shadow: 0 15px 30px rgba(240, 147, 251, 0.4);
        }
        
        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
            border-radius: 8px;
        }
        
        .btn-green {
            background: #059669;
            color: white;
        }
        
        .btn-green:hover {
            background: #047857;
        }
        
        .btn-gray {
            background: #6b7280;
            color: white;
        }
        
        .btn-gray:hover {
            background: #4b5563;
        }
        
        .select {
            padding: 0.5rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            background: white;
            font-size: 0.875rem;
            min-width: 120px;
        }
        
        .hidden { display: none; }
        
        .message {
            padding: 1rem;
            border-radius: 12px;
            margin: 1rem 0;
            animation: slideIn 0.3s ease-out;
        }
        
        .message-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }
        
        .message-success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }
        
        .message-warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fde68a;
        }
        
        .message-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .data-quality {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            padding: 1.5rem;
            border-radius: 20px;
            margin-bottom: 1.5rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .quality-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: #1a202c;
        }
        
        .quality-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }
        
        .quality-stat {
            text-align: center;
            padding: 0.75rem;
            background: rgba(255,255,255,0.7);
            border-radius: 12px;
        }
        
        .quality-number {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }
        
        .quality-label {
            font-size: 0.75rem;
            color: #64748b;
            text-transform: uppercase;
            font-weight: 600;
        }
        
        .filters-section {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            padding: 1.5rem;
            border-radius: 20px;
            margin-bottom: 1.5rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .filters-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: #1a202c;
        }
        
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .filter-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: #374151;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        @media (min-width: 768px) {
            .summary-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }
        
        .summary-card {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            padding: 1.5rem;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            text-align: center;
            border: 1px solid rgba(255,255,255,0.2);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
        }
        
        @media (min-width: 768px) {
            .summary-card { padding: 2rem; }
        }
        
        .summary-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #8b1538, #4a1625);
            border-radius: 20px 20px 0 0;
        }
        
        .summary-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
        }
        
        .summary-number {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            letter-spacing: -0.02em;
        }
        
        @media (min-width: 768px) {
            .summary-number { font-size: 2.5rem; }
        }
        
        .summary-label {
            font-size: 0.8rem;
            color: #64748b;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-top: 0.5rem;
        }
        
        @media (min-width: 768px) {
            .summary-label { font-size: 0.875rem; }
        }
        
        .blue { 
            background: linear-gradient(135deg, #8b1538, #4a1625);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .green { 
            background: linear-gradient(135deg, #56ab2f, #a8e6cf);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .red { 
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .orange { 
            background: linear-gradient(135deg, #f093fb, #f5576c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        @media (min-width: 768px) {
            .charts-grid {
                grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            }
        }
        
        .chart-card {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            padding: 1.5rem;
            border-radius: 24px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            min-height: 350px;
            border: 1px solid rgba(255,255,255,0.2);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
        }
        
        @media (min-width: 768px) {
            .chart-card {
                padding: 2rem;
                min-height: 400px;
            }
        }
        
        .chart-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #8b1538, #4a1625);
            border-radius: 24px 24px 0 0;
        }
        
        .chart-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
        }
        
        .chart-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 1rem;
            text-align: center;
            color: #1a202c;
            background: linear-gradient(135deg, #8b1538, #4a1625);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.01em;
        }
        
        @media (min-width: 768px) {
            .chart-title {
                font-size: 1.375rem;
                margin-bottom: 1.5rem;
            }
        }
        
        .chart-content {
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .loading-spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #8b1538;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
        
        .bar-chart { flex: 1; }
        
        .bar-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
            padding: 0.75rem;
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.3);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
        }
        
        @media (min-width: 768px) {
            .bar-item {
                margin-bottom: 1rem;
                padding: 1rem;
            }
        }
        
        .bar-item:hover {
            background: rgba(255,255,255,0.95);
            transform: translateX(4px) scale(1.02);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .bar-label {
            width: 100px;
            font-weight: 600;
            font-size: 0.8rem;
            margin-right: 0.75rem;
            color: #1a202c;
        }
        
        @media (min-width: 768px) {
            .bar-label {
                width: 140px;
                font-size: 0.9rem;
                margin-right: 1rem;
            }
        }
        
        .bar-visual {
            flex: 1;
            height: 24px;
            background: rgba(230,230,230,0.5);
            border-radius: 12px;
            overflow: hidden;
            margin-right: 0.75rem;
            position: relative;
        }
        
        @media (min-width: 768px) {
            .bar-visual {
                height: 28px;
                border-radius: 14px;
                margin-right: 1rem;
            }
        }
        
        .bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #8b1538, #4a1625);
            transition: width 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border-radius: inherit;
            position: relative;
            overflow: hidden;
        }
        
        .bar-value {
            width: 60px;
            text-align: right;
            font-weight: 700;
            font-size: 0.8rem;
            color: #1a202c;
        }
        
        @media (min-width: 768px) {
            .bar-value {
                width: 80px;
                font-size: 0.9rem;
            }
        }
        
        .pie-chart-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
        }
        
        .pie-chart {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            margin-bottom: 1rem;
            position: relative;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        @media (min-width: 768px) {
            .pie-chart {
                width: 200px;
                height: 200px;
            }
        }
        
        .pie-chart:hover { transform: scale(1.05); }
        
        .pie-legend {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.7rem;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }
        
        @media (min-width: 768px) {
            .legend-item { font-size: 0.75rem; }
        }
        
        .legend-item:hover { background: rgba(139, 21, 56, 0.1); }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }
        
        .donut-chart {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            margin-bottom: 1rem;
            position: relative;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        @media (min-width: 768px) {
            .donut-chart {
                width: 200px;
                height: 200px;
            }
        }
        
        .donut-chart:hover { transform: scale(1.05); }
        
        .donut-inner {
            position: absolute;
            top: 25%;
            left: 25%;
            width: 50%;
            height: 50%;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #6b7280;
            font-size: 0.9rem;
        }
        
        @media (min-width: 768px) {
            .donut-inner { font-size: 1rem; }
        }
        
        .list-chart { flex: 1; }
        
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            margin-bottom: 0.75rem;
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            border-left: 4px solid;
            border-left-color: #8b1538;
            border: 1px solid rgba(255,255,255,0.3);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }
        
        @media (min-width: 768px) {
            .list-item {
                padding: 1.25rem;
                margin-bottom: 1rem;
            }
        }
        
        .list-item:hover {
            background: rgba(255,255,255,0.95);
            transform: translateX(6px) scale(1.02);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        
        .list-rank {
            font-weight: 700;
            color: #64748b;
            margin-right: 0.5rem;
            min-width: 30px;
        }
        
        .list-name {
            flex: 1;
            font-weight: 600;
            color: #1e293b;
            font-size: 0.9rem;
        }
        
        @media (min-width: 768px) {
            .list-name { font-size: 1rem; }
        }
        
        .list-stats { text-align: right; }
        
        .list-count {
            font-weight: 700;
            color: #1e293b;
            font-size: 0.9rem;
        }
        
        @media (min-width: 768px) {
            .list-count { font-size: 1rem; }
        }
        
        .list-percent {
            font-size: 0.7rem;
            color: #64748b;
            font-weight: 500;
        }
        
        .customize-panel {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            padding: 1.5rem;
            border-radius: 24px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            margin-bottom: 2rem;
            display: none;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        @media (min-width: 768px) {
            .customize-panel { padding: 2rem; }
        }
        
        .customize-panel.show {
            display: block;
            animation: slideIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .customize-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: #1a202c;
            background: linear-gradient(135deg, #8b1538, #4a1625);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .field-config {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding: 1.5rem;
            border: 1px solid rgba(230,230,230,0.5);
            border-radius: 16px;
            background: rgba(255,255,255,0.7);
            backdrop-filter: blur(10px);
        }
        
        @media (min-width: 768px) {
            .field-config {
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                gap: 1.5rem;
            }
        }
        
        .field-config label {
            font-size: 0.875rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
            display: block;
        }
        
        .field-config input,
        .field-config select {
            width: 100%;
            padding: 0.875rem;
            border: 2px solid rgba(230,230,230,0.8);
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.3s ease;
            background: rgba(255,255,255,0.9);
        }
        
        .field-config input:focus,
        .field-config select:focus {
            outline: none;
            border-color: #8b1538;
            box-shadow: 0 0 0 3px rgba(139, 21, 56, 0.1);
            background: rgba(255,255,255,1);
        }
        
        .btn-group {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        
        .export-section {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
            margin: 1.5rem 0;
        }
        
        .footer {
            text-align: center;
            margin-top: 2rem;
            color: #6b7280;
            font-size: 0.875rem;
        }
        
        .status {
            color: #8b1538;
            font-weight: 500;
            font-size: 0.8rem;
        }
        
        @media (min-width: 768px) {
            .status { font-size: 0.875rem; }
        }
        
        .chart-tooltip {
            position: absolute;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            font-size: 0.8rem;
            pointer-events: none;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.2s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .chart-tooltip.show { opacity: 1; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title" id="dashboardTitle" onclick="editTitle()">Enhanced Demographics Dashboard</h1>
            <input type="text" class="title-input hidden" id="titleInput" value="Enhanced Demographics Dashboard">
            <div class="title-edit-hint">Click title to edit</div>
            
            <div class="upload-section">
                <div class="upload-controls">
                    <label class="upload-btn">
                        📁 Upload CSV
                        <input type="file" accept=".csv,.tsv,.txt" class="hidden" id="csvFile">
                    </label>
                    
                    <button class="btn btn-blue" id="customizeBtn">
                        ⚙️ Customize Charts
                    </button>
                    
                    <button class="btn btn-red" id="exportBtn">
                        📄 Export PDF
                    </button>
                    
                    <span class="status" id="status">Ready</span>
                </div>
                
                <div id="messageContainer"></div>
            </div>
        </div>

        <!-- Data Quality Section -->
        <div class="data-quality hidden" id="dataQuality">
            <h3 class="quality-title">Data Quality Overview</h3>
            <div class="quality-stats" id="qualityStats"></div>
        </div>

        <!-- Enhanced Filters Section -->
        <div class="filters-section hidden" id="filtersSection">
            <h3 class="filters-title">Advanced Filters</h3>
            <div class="filters-grid" id="filtersGrid"></div>
            <div style="margin-top: 1rem;">
                <button class="btn-small btn-gray" id="clearFiltersBtn">Clear All Filters</button>
            </div>
        </div>

        <!-- Customization Panel -->
        <div class="customize-panel" id="customizePanel">
            <h3 class="customize-title">Customize Dashboard</h3>
            <div id="chartConfigs"></div>
            <div class="btn-group">
                <button class="btn-small btn-green" id="addChartBtn">+ Add Chart</button>
                <button class="btn-small btn-gray" id="closeCustomizeBtn">Done</button>
            </div>
        </div>

        <!-- Export Section -->
        <div class="export-section">
            <button class="btn-small btn-blue" id="exportDataBtn">📊 Export Filtered Data (CSV)</button>
        </div>

        <div class="summary-grid" id="summaryCards">
            <div class="summary-card">
                <div class="summary-number blue" id="totalRecords">0</div>
                <div class="summary-label">Total Records</div>
            </div>
        </div>

        <div class="charts-grid" id="chartsContainer"></div>
        
        <div class="footer">
            <p>Enhanced Dashboard ready! Upload a CSV file to analyze your data.</p>
            <p id="recordCount">No data loaded</p>
        </div>
    </div>

    <div class="chart-tooltip" id="chartTooltip"></div>

    <script>
        // Global variables
        let currentData = [];
        let filteredData = [];
        let availableFields = [];
        let chartConfigs = [];
        let activeFilters = {};
        let isInitialized = false;
        let dashboardTitle = "Enhanced Demographics Dashboard";
        let dataQuality = {};

        // Utility functions
        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toLocaleString();
        }

        function showMessage(message, type = 'info', duration = 5000) {
            const container = document.getElementById('messageContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${type}`;
            messageDiv.textContent = message;
            
            container.appendChild(messageDiv);
            
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, duration);
        }

        // CSV parsing functions
        function parseCSV(text) {
            try {
                const lines = text.split('\n').filter(line => line.trim());
                if (lines.length < 2) {
                    throw new Error('CSV file must contain at least a header row and one data row');
                }
                
                const delimiter = detectDelimiter(lines[0]);
                const headers = parseCSVLine(lines[0], delimiter).map(h => h.trim());
                const data = [];
                
                for (let i = 1; i < lines.length; i++) {
                    const values = parseCSVLine(lines[i], delimiter);
                    if (values.length === headers.length) {
                        const row = {};
                        headers.forEach((header, index) => {
                            row[header] = values[index]?.trim() || '';
                        });
                        data.push(row);
                    }
                }
                
                return data;
            } catch (error) {
                throw new Error(`CSV parsing failed: ${error.message}`);
            }
        }

        function detectDelimiter(line) {
            const delimiters = [',', '\t', ';', '|'];
            let maxColumns = 0;
            let bestDelimiter = ',';
            
            for (const del of delimiters) {
                const columns = line.split(del).length;
                if (columns > maxColumns) {
                    maxColumns = columns;
                    bestDelimiter = del;
                }
            }
            
            return bestDelimiter;
        }

        function parseCSVLine(line, delimiter = ',') {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];
                
                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === delimiter && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result;
        }

        // Data analysis functions
        function analyzeDataQuality(data) {
            if (!data || data.length === 0) return {};
            
            const fields = Object.keys(data[0]);
            const totalRows = data.length;
            let completeRows = 0;
            let duplicateRows = 0;
            const seenRows = new Set();
            
            data.forEach(row => {
                const rowString = JSON.stringify(row);
                if (seenRows.has(rowString)) {
                    duplicateRows++;
                } else {
                    seenRows.add(rowString);
                }
                
                const isComplete = fields.every(field => row[field] && row[field].toString().trim() !== '');
                if (isComplete) completeRows++;
            });
            
            return {
                totalRows,
                completeRows,
                duplicateRows,
                completeness: (completeRows / totalRows * 100).toFixed(1),
                uniqueness: ((totalRows - duplicateRows) / totalRows * 100).toFixed(1)
            };
        }

        function detectFields(data) {
            if (!data || data.length === 0) return { categorical: [], numerical: [], date: [] };
            
            const allFields = Object.keys(data[0]);
            const categorical = [];
            const numerical = [];
            const dateFields = [];
            
            allFields.forEach(field => {
                const sampleSize = Math.min(100, data.length);
                const sampleValues = data.slice(0, sampleSize).map(row => row[field]).filter(v => v !== null && v !== undefined && v !== '');
                
                if (sampleValues.length === 0) return;
                
                const uniqueValues = new Set(sampleValues);
                const uniqueCount = uniqueValues.size;
                const uniquenessRatio = uniqueCount / sampleValues.length;
                
                const numericValues = sampleValues.filter(v => !isNaN(v) && !isNaN(parseFloat(v)));
                const numericRatio = numericValues.length / sampleValues.length;
                
                if (numericRatio > 0.8 && uniqueCount > 10) {
                    numerical.push(field);
                } else if (uniqueCount >= 2 && uniqueCount <= 50 && uniquenessRatio < 0.8) {
                    categorical.push(field);
                }
            });
            
            return { categorical, numerical, date: dateFields };
        }

        // Chart functions
        function getFieldCounts(field, valueFilter = null) {
            if (!field) return [];
            
            let dataToUse = filteredData;
            
            if (valueFilter && valueFilter.values && valueFilter.values.length > 0) {
                if (valueFilter.mode === 'include') {
                    dataToUse = filteredData.filter(row => valueFilter.values.includes(row[field]));
                } else if (valueFilter.mode === 'exclude') {
                    dataToUse = filteredData.filter(row => !valueFilter.values.includes(row[field]));
                }
            }
            
            const counts = {};
            dataToUse.forEach(row => {
                const value = row[field];
                if (value && value !== '') {
                    counts[value] = (counts[value] || 0) + 1;
                }
            });
            
            return Object.entries(counts)
                .map(([name, count]) => ({ name, count }))
                .sort((a, b) => b.count - a.count)
                .slice(0, 15);
        }

        function createChart(container, config) {
            container.innerHTML = '<div class="loading-spinner"></div>';
            
            setTimeout(() => {
                const data = getFieldCounts(config.field, config.valueFilter);
                container.innerHTML = '';
                
                switch (config.type) {
                    case 'bar':
                        createBarChart(container, data, config);
                        break;
                    case 'pie':
                        createPieChart(container, data, config);
                        break;
                    case 'donut':
                        createDonutChart(container, data, config);
                        break;
                    case 'list':
                        createListChart(container, data, config);
                        break;
                    default:
                        createBarChart(container, data, config);
                }
            }, 100);
        }

        function createBarChart(container, data, config) {
            const maxValue = Math.max(...data.map(d => d.count));
            const colors = ['#2563eb', '#dc2626', '#f59e0b', '#10b981', '#8b5cf6', '#f97316'];
            
            const chartDiv = document.createElement('div');
            chartDiv.className = 'bar-chart';
            
            data.forEach((item, index) => {
                const percentage = maxValue > 0 ? (item.count / maxValue) * 100 : 0;
                const barItem = document.createElement('div');
                barItem.className = 'bar-item';
                
                barItem.innerHTML = `
                    <div class="bar-label">${item.name}</div>
                    <div class="bar-visual">
                        <div class="bar-fill" style="width: 0%; background: ${colors[index % colors.length]};"></div>
                    </div>
                    <div class="bar-value">${formatNumber(item.count)}</div>
                `;
                
                barItem.addEventListener('click', () => handleChartItemClick(config.field, item.name));
                
                chartDiv.appendChild(barItem);
                
                setTimeout(() => {
                    const fillElement = barItem.querySelector('.bar-fill');
                    fillElement.style.width = `${percentage}%`;
                }, 50 * index);
            });
            
            container.appendChild(chartDiv);
        }

        function createPieChart(container, data, config) {
            const total = data.reduce((sum, item) => sum + item.count, 0);
            const colors = ['#2563eb', '#dc2626', '#f59e0b', '#10b981', '#8b5cf6', '#f97316'];
            
            const pieContainer = document.createElement('div');
            pieContainer.className = 'pie-chart-container';
            
            const pieChart = document.createElement('div');
            pieChart.className = 'pie-chart';
            
            let currentAngle = 0;
            const gradients = [];
            
            data.forEach((item, index) => {
                const percentage = total > 0 ? (item.count / total) * 100 : 0;
                const angle = (percentage / 100) * 360;
                
                gradients.push(`${colors[index % colors.length]} ${currentAngle}deg ${currentAngle + angle}deg`);
                currentAngle += angle;
            });
            
            pieChart.style.background = `conic-gradient(${gradients.join(', ')})`;
            pieContainer.appendChild(pieChart);
            
            const legend = document.createElement('div');
            legend.className = 'pie-legend';
            
            data.forEach((item, index) => {
                const percentage = total > 0 ? ((item.count / total) * 100).toFixed(1) : 0;
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item';
                
                legendItem.innerHTML = `
                    <div class="legend-color" style="background: ${colors[index % colors.length]};"></div>
                    <span>${item.name}: ${percentage}%</span>
                `;
                
                legendItem.addEventListener('click', () => handleChartItemClick(config.field, item.name));
                legend.appendChild(legendItem);
            });
            
            pieContainer.appendChild(legend);
            container.appendChild(pieContainer);
        }

        function createDonutChart(container, data, config) {
            const total = data.reduce((sum, item) => sum + item.count, 0);
            const colors = ['#2563eb', '#dc2626', '#f59e0b', '#10b981', '#8b5cf6', '#f97316'];
            
            const donutContainer = document.createElement('div');
            donutContainer.className = 'pie-chart-container';
            
            const donutChart = document.createElement('div');
            donutChart.className = 'donut-chart';
            
            let currentAngle = 0;
            const gradients = [];
            
            data.forEach((item, index) => {
                const percentage = total > 0 ? (item.count / total) * 100 : 0;
                const angle = (percentage / 100) * 360;
                
                gradients.push(`${colors[index % colors.length]} ${currentAngle}deg ${currentAngle + angle}deg`);
                currentAngle += angle;
            });
            
            donutChart.style.background = `conic-gradient(${gradients.join(', ')})`;
            
            const innerCircle = document.createElement('div');
            innerCircle.className = 'donut-inner';
            innerCircle.textContent = formatNumber(total);
            donutChart.appendChild(innerCircle);
            
            donutContainer.appendChild(donutChart);
            
            const legend = document.createElement('div');
            legend.className = 'pie-legend';
            
            data.forEach((item, index) => {
                const percentage = total > 0 ? ((item.count / total) * 100).toFixed(1) : 0;
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item';
                
                legendItem.innerHTML = `
                    <div class="legend-color" style="background: ${colors[index % colors.length]};"></div>
                    <span>${item.name}: ${percentage}%</span>
                `;
                
                legendItem.addEventListener('click', () => handleChartItemClick(config.field, item.name));
                legend.appendChild(legendItem);
            });
            
            donutContainer.appendChild(legend);
            container.appendChild(donutContainer);
        }

        function createListChart(container, data, config) {
            const total = filteredData.length;
            const colors = ['#2563eb', '#dc2626', '#f59e0b', '#10b981', '#8b5cf6', '#f97316'];
            
            const listDiv = document.createElement('div');
            listDiv.className = 'list-chart';
            
            data.forEach((item, index) => {
                const percentage = total > 0 ? ((item.count / total) * 100).toFixed(1) : 0;
                const listItem = document.createElement('div');
                listItem.className = 'list-item';
                listItem.style.borderLeftColor = colors[index % colors.length];
                
                listItem.innerHTML = `
                    <span class="list-rank">${index + 1}.</span>
                    <span class="list-name">${item.name}</span>
                    <div class="list-stats">
                        <div class="list-count">${formatNumber(item.count)}</div>
                        <div class="list-percent">${percentage}%</div>
                    </div>
                `;
                
                listItem.addEventListener('click', () => handleChartItemClick(config.field, item.name));
                listDiv.appendChild(listItem);
            });
            
            container.appendChild(listDiv);
        }

        // Filter functions
        function handleChartItemClick(field, value) {
            if (!activeFilters[field]) {
                activeFilters[field] = { type: 'categorical', values: [] };
            }
            
            if (activeFilters[field].type === 'categorical') {
                const values = activeFilters[field].values;
                if (values.includes(value)) {
                    activeFilters[field].values = values.filter(v => v !== value);
                    if (activeFilters[field].values.length === 0) {
                        delete activeFilters[field];
                    }
                    showMessage(`Removed filter: ${field} = ${value}`, 'info', 2000);
                } else {
                    activeFilters[field].values.push(value);
                    showMessage(`Added filter: ${field} = ${value}`, 'info', 2000);
                }
                
                applyFilters();
            }
        }

        function createAdvancedFilters() {
            const filtersGrid = document.getElementById('filtersGrid');
            const filtersSection = document.getElementById('filtersSection');
            
            if (availableFields.length === 0) {
                filtersSection.classList.add('hidden');
                return;
            }
            
            filtersGrid.innerHTML = '';
            
            const detectedFields = detectFields(currentData);
            
            detectedFields.categorical.forEach(field => {
                const uniqueValues = [...new Set(currentData.map(row => row[field]).filter(v => v))].sort();
                if (uniqueValues.length > 1) {
                    const filterGroup = createCategoricalFilter(field, uniqueValues);
                    filtersGrid.appendChild(filterGroup);
                }
            });
            
            filtersSection.classList.remove('hidden');
        }

        function createCategoricalFilter(field, values) {
            const div = document.createElement('div');
            div.className = 'filter-group';
            
            const label = document.createElement('label');
            label.className = 'filter-label';
            label.textContent = field.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            
            const select = document.createElement('select');
            select.className = 'select';
            select.id = `filter_${field}`;
            select.multiple = true;
            select.size = Math.min(4, values.length);
            
            values.forEach(value => {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = value;
                select.appendChild(option);
            });
            
            select.addEventListener('change', () => {
                const selectedValues = Array.from(select.selectedOptions).map(opt => opt.value);
                if (selectedValues.length === 0) {
                    delete activeFilters[field];
                } else {
                    activeFilters[field] = { type: 'categorical', values: selectedValues };
                }
                applyFilters();
            });
            
            div.appendChild(label);
            div.appendChild(select);
            
            return div;
        }

        function applyFilters() {
            filteredData = currentData.filter(row => {
                return Object.entries(activeFilters).every(([field, filter]) => {
                    const value = row[field];
                    
                    if (filter.type === 'categorical') {
                        return filter.values.includes(value);
                    }
                    
                    return true;
                });
            });
            
            updateDashboard();
            
            const filterCount = Object.keys(activeFilters).length;
            if (filterCount > 0) {
                showMessage(`Applied ${filterCount} filter(s). Showing ${filteredData.length} of ${currentData.length} records.`, 'info', 3000);
            }
        }

        function clearAllFilters() {
            activeFilters = {};
            
            const selects = document.querySelectorAll('#filtersGrid select');
            selects.forEach(select => {
                Array.from(select.options).forEach(option => option.selected = false);
            });
            
            filteredData = [...currentData];
            updateDashboard();
            showMessage('All filters cleared', 'info', 2000);
        }

        // Export functions
        function exportFilteredData() {
            if (filteredData.length === 0) {
                showMessage('No data to export', 'warning', 3000);
                return;
            }
            
            const csv = convertToCSV(filteredData);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `${dashboardTitle.replace(/\s+/g, '_')}_filtered_data_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showMessage(`Exported ${filteredData.length} records to CSV`, 'success', 3000);
            }
        }

        function convertToCSV(data) {
            if (data.length === 0) return '';
            
            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => 
                    headers.map(header => {
                        const value = row[header] || '';
                        if (value.toString().includes(',') || value.toString().includes('"')) {
                            return `"${value.toString().replace(/"/g, '""')}"`;
                        }
                        return value;
                    }).join(',')
                )
            ].join('\n');
            
            return csvContent;
        }

        function exportToPDF() {
            const button = document.getElementById('exportBtn');
            const originalText = button.textContent;
            button.textContent = '📄 Generating PDF...';
            button.disabled = true;
            
            try {
                const currentDate = new Date().toLocaleDateString();
                const recordCount = formatNumber(filteredData.length);
                const totalCount = formatNumber(currentData.length);
                
                const chartData = chartConfigs.map(config => {
                    const data = getFieldCounts(config.field, config.valueFilter);
                    return {
                        title: config.title,
                        type: config.type,
                        data: data.slice(0, 10),
                        total: data.reduce((sum, item) => sum + item.count, 0)
                    };
                });
                
                const printContent = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>${dashboardTitle} - Report</title>
                        <meta charset="UTF-8">
                        <style>
                            * { margin: 0; padding: 0; box-sizing: border-box; }
                            body { 
                                font-family: 'Segoe UI', Arial, sans-serif; 
                                line-height: 1.4;
                                color: #333;
                                max-width: 800px;
                                margin: 0 auto;
                                padding: 20px;
                            }
                            .header { 
                                text-align: center; 
                                border-bottom: 3px solid #4a5568; 
                                padding-bottom: 20px; 
                                margin-bottom: 30px; 
                            }
                            .title { 
                                font-size: 28px; 
                                font-weight: bold; 
                                margin-bottom: 5px;
                                color: #2d3748;
                            }
                            .subtitle { 
                                color: #666; 
                                font-size: 14px;
                                margin-bottom: 5px; 
                            }
                            .summary-section {
                                background: #f8fafc;
                                padding: 20px;
                                margin-bottom: 30px;
                                border: 1px solid #e2e8f0;
                                border-radius: 8px;
                            }
                            .summary-title {
                                font-size: 18px;
                                font-weight: bold;
                                margin-bottom: 15px;
                                color: #2d3748;
                            }
                            .chart-section { 
                                margin-bottom: 40px;
                                page-break-inside: avoid;
                            }
                            .chart-title { 
                                font-size: 16px; 
                                font-weight: bold; 
                                margin-bottom: 15px;
                                color: #2d3748;
                                border-bottom: 2px solid #4a5568;
                                padding-bottom: 5px;
                            }
                            .data-table {
                                width: 100%;
                                border-collapse: collapse;
                                margin-bottom: 10px;
                            }
                            .data-table th {
                                background: #4a5568;
                                color: white;
                                padding: 10px;
                                text-align: left;
                                font-weight: bold;
                            }
                            .data-table td {
                                padding: 8px 10px;
                                border-bottom: 1px solid #e2e8f0;
                            }
                            .data-table tr:nth-child(even) {
                                background: #f8fafc;
                            }
                            .rank { 
                                font-weight: bold; 
                                color: #4a5568;
                                width: 40px;
                                text-align: center;
                            }
                            .name { font-weight: 500; }
                            .count { 
                                font-weight: bold; 
                                text-align: right;
                                width: 80px;
                            }
                            .percent { 
                                color: #666; 
                                text-align: right;
                                width: 60px;
                            }
                            .footer { 
                                text-align: center; 
                                margin-top: 40px; 
                                padding-top: 20px;
                                border-top: 1px solid #e2e8f0;
                                color: #666; 
                                font-size: 12px; 
                            }
                            @media print {
                                body { margin: 0; padding: 15px; }
                                .chart-section { page-break-inside: avoid; }
                                .header { page-break-after: avoid; }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <div class="title">${dashboardTitle}</div>
                            <div class="subtitle">Data Analysis Report</div>
                            <div class="subtitle">Generated on ${currentDate}</div>
                        </div>
                        
                        <div class="summary-section">
                            <div class="summary-title">Executive Summary</div>
                            <p>Total Records: ${totalCount}</p>
                            <p>Filtered Records: ${recordCount}</p>
                            <p>Charts: ${chartData.length}</p>
                            <p>Data Completeness: ${dataQuality.completeness || 'N/A'}%</p>
                        </div>
                        
                        ${chartData.map(chart => `
                            <div class="chart-section">
                                <div class="chart-title">${chart.title} Analysis</div>
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Rank</th>
                                            <th>Category</th>
                                            <th>Count</th>
                                            <th>Percentage</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${chart.data.map((item, index) => {
                                            const percentage = chart.total > 0 ? ((item.count / chart.total) * 100).toFixed(1) : '0.0';
                                            return `
                                                <tr>
                                                    <td class="rank">${index + 1}</td>
                                                    <td class="name">${item.name}</td>
                                                    <td class="count">${formatNumber(item.count)}</td>
                                                    <td class="percent">${percentage}%</td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `).join('')}
                        
                        <div class="footer">
                            <p><strong>${dashboardTitle} - Analysis Report</strong></p>
                            <p>Generated on ${currentDate}</p>
                            <p>Total Records: ${totalCount} | Analyzed: ${recordCount}</p>
                        </div>
                    </body>
                    </html>
                `;
                
                const printWindow = window.open('', '_blank', 'width=800,height=600');
                printWindow.document.write(printContent);
                printWindow.document.close();
                
                printWindow.onload = function() {
                    setTimeout(() => {
                        printWindow.focus();
                        printWindow.print();
                        
                        setTimeout(() => {
                            if (!printWindow.closed) {
                                printWindow.close();
                            }
                            button.textContent = originalText;
                            button.disabled = false;
                        }, 1000);
                    }, 500);
                };
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                showMessage('Error generating PDF. Please try again.', 'error');
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        // Dashboard functions
        function updateDataQualityDisplay() {
            const qualitySection = document.getElementById('dataQuality');
            const qualityStats = document.getElementById('qualityStats');
            
            if (Object.keys(dataQuality).length === 0) {
                qualitySection.classList.add('hidden');
                return;
            }
            
            qualityStats.innerHTML = `
                <div class="quality-stat">
                    <div class="quality-number green">${dataQuality.completeness}%</div>
                    <div class="quality-label">Completeness</div>
                </div>
                <div class="quality-stat">
                    <div class="quality-number blue">${dataQuality.uniqueness}%</div>
                    <div class="quality-label">Uniqueness</div>
                </div>
                <div class="quality-stat">
                    <div class="quality-number orange">${formatNumber(dataQuality.completeRows)}</div>
                    <div class="quality-label">Complete Rows</div>
                </div>
                <div class="quality-stat">
                    <div class="quality-number ${dataQuality.duplicateRows > 0 ? 'red' : 'green'}">${formatNumber(dataQuality.duplicateRows)}</div>
                    <div class="quality-label">Duplicates</div>
                </div>
            `;
            
            qualitySection.classList.remove('hidden');
        }

        function generateDefaultChartConfigs(fields) {
            const chartTypes = ['donut', 'bar', 'list', 'pie'];
            return fields.slice(0, 6).map((field, index) => ({
                id: `chart_${index}`,
                field: field,
                title: field.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                type: chartTypes[index % chartTypes.length],
                valueFilter: {
                    mode: 'include',
                    values: []
                }
            }));
        }

        function renderCharts() {
            const container = document.getElementById('chartsContainer');
            container.innerHTML = '';
            
            chartConfigs.forEach((config, index) => {
                const chartDiv = document.createElement('div');
                chartDiv.className = 'chart-card';
                chartDiv.style.animationDelay = `${index * 0.1}s`;
                chartDiv.innerHTML = `
                    <h3 class="chart-title">${config.title}</h3>
                    <div class="chart-content" id="${config.id}"></div>
                `;
                container.appendChild(chartDiv);
                
                const chartContainer = document.getElementById(config.id);
                createChart(chartContainer, config);
            });
        }

        function updateCustomizationPanel() {
            const container = document.getElementById('chartConfigs');
            container.innerHTML = '';
            
            chartConfigs.forEach((config, index) => {
                const div = document.createElement('div');
                div.className = 'field-config';
                div.innerHTML = `
                    <div>
                        <label>Chart Title:</label>
                        <input type="text" value="${config.title}" onchange="updateChartConfig(${index}, 'title', this.value)">
                    </div>
                    <div>
                        <label>Data Field:</label>
                        <select onchange="updateChartConfig(${index}, 'field', this.value)">
                            ${availableFields.map(field => 
                                `<option value="${field}" ${field === config.field ? 'selected' : ''}>${field.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div>
                        <label>Chart Type:</label>
                        <select onchange="updateChartConfig(${index}, 'type', this.value)">
                            <option value="bar" ${config.type === 'bar' ? 'selected' : ''}>📊 Bar Chart</option>
                            <option value="pie" ${config.type === 'pie' ? 'selected' : ''}>🥧 Pie Chart</option>
                            <option value="donut" ${config.type === 'donut' ? 'selected' : ''}>🍩 Donut Chart</option>
                            <option value="list" ${config.type === 'list' ? 'selected' : ''}>📋 Top List</option>
                        </select>
                    </div>
                    <div>
                        <button class="btn-small btn-red" onclick="removeChart(${index})">Remove Chart</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function updateChartConfig(index, property, value) {
            if (chartConfigs[index]) {
                chartConfigs[index][property] = value;
                
                if (property === 'field') {
                    chartConfigs[index].valueFilter = { mode: 'include', values: [] };
                    updateCustomizationPanel();
                }
                
                renderCharts();
            }
        }

        function removeChart(index) {
            chartConfigs.splice(index, 1);
            updateCustomizationPanel();
            renderCharts();
        }

        function addChart() {
            if (availableFields.length === 0) return;
            
            const newChart = {
                id: `chart_${Date.now()}`,
                field: availableFields[0],
                title: 'New Chart',
                type: 'bar',
                valueFilter: {
                    mode: 'include',
                    values: []
                }
            };
            chartConfigs.push(newChart);
            updateCustomizationPanel();
            renderCharts();
        }

        function updateDashboard() {
            const totalRecords = filteredData.length;
            document.getElementById('totalRecords').textContent = formatNumber(totalRecords);
            
            renderCharts();
            
            const filterCount = Object.keys(activeFilters).length;
            const recordText = filterCount > 0 
                ? `Showing ${formatNumber(totalRecords)} filtered records (${Object.keys(activeFilters).length} filter(s) active)`
                : `Showing ${formatNumber(totalRecords)} total records`;
            document.getElementById('recordCount').textContent = recordText;
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const validTypes = ['.csv', '.tsv', '.txt'];
            const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
            
            if (!validTypes.includes(fileExtension)) {
                showMessage('Please upload a CSV, TSV, or TXT file.', 'error');
                return;
            }
            
            if (file.size > 10 * 1024 * 1024) {
                showMessage('File too large. Please upload a file smaller than 10MB.', 'error');
                return;
            }
            
            document.getElementById('status').textContent = 'Processing file...';
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvData = parseCSV(e.target.result);
                    
                    if (csvData.length === 0) {
                        throw new Error('No valid data found in file');
                    }
                    
                    if (csvData.length > 100000) {
                        showMessage(`Large dataset detected (${formatNumber(csvData.length)} rows). Processing may take a moment.`, 'warning');
                    }
                    
                    currentData = csvData;
                    filteredData = [...currentData];
                    
                    dataQuality = analyzeDataQuality(currentData);
                    updateDataQualityDisplay();
                    
                    const detectedFields = detectFields(currentData);
                    availableFields = detectedFields.categorical;
                    
                    if (availableFields.length === 0) {
                        showMessage('No suitable categorical fields found for visualization. Using first 5 fields as fallback.', 'warning');
                        availableFields = Object.keys(currentData[0]).slice(0, 5);
                    }
                    
                    chartConfigs = generateDefaultChartConfigs(availableFields);
                    activeFilters = {};
                    
                    createAdvancedFilters();
                    updateCustomizationPanel();
                    updateDashboard();
                    
                    showMessage(`Successfully loaded ${formatNumber(csvData.length)} records with ${availableFields.length} visualizable fields.`, 'success');
                    document.getElementById('status').textContent = `Loaded ${formatNumber(csvData.length)} records`;
                    
                } catch (error) {
                    console.error('File processing error:', error);
                    showMessage(error.message, 'error');
                    document.getElementById('status').textContent = 'Error loading file';
                }
            };
            
            reader.onerror = function() {
                showMessage('Error reading file. Please try again.', 'error');
                document.getElementById('status').textContent = 'Error reading file';
            };
            
            reader.readAsText(file);
        }

        // Title editing functions
        function editTitle() {
            const titleElement = document.getElementById('dashboardTitle');
            const inputElement = document.getElementById('titleInput');
            
            titleElement.classList.add('hidden');
            inputElement.classList.remove('hidden');
            inputElement.value = dashboardTitle;
            inputElement.focus();
            inputElement.select();
        }

        function saveTitle() {
            const titleElement = document.getElementById('dashboardTitle');
            const inputElement = document.getElementById('titleInput');
            
            dashboardTitle = inputElement.value.trim() || "Enhanced Demographics Dashboard";
            titleElement.textContent = dashboardTitle;
            
            inputElement.classList.add('hidden');
            titleElement.classList.remove('hidden');
        }

        function handleTitleKeypress(event) {
            if (event.key === 'Enter') {
                event.target.blur();
            }
            if (event.key === 'Escape') {
                const titleElement = document.getElementById('dashboardTitle');
                const inputElement = document.getElementById('titleInput');
                
                inputElement.value = dashboardTitle;
                inputElement.classList.add('hidden');
                titleElement.classList.remove('hidden');
            }
        }

        // Generate sample data for demo
        function generateSampleData() {
            const data = [];
            const states = ['California', 'Texas', 'Florida', 'New York', 'Illinois', 'Arizona', 'Virginia'];
            const genders = ['Female', 'Male', 'Non-binary'];
            const ageRanges = ['18-24', '25-34', '35-44', '45-54', '55-64', '65+'];
            const parties = ['Democratic', 'Republican', 'Independent', 'Green', 'Libertarian'];
            const ethnicities = ['White', 'Hispanic/Latino', 'African American', 'Asian', 'Native American', 'Mixed', 'Other'];
            const education = ['High School', 'Some College', 'Bachelor\'s', 'Master\'s', 'Doctorate'];
            const income = ['<$25k', '$25k-$50k', '$50k-$75k', '$75k-$100k', '$100k+'];

            for (let i = 0; i < 2500; i++) {
                data.push({
                    voter_id: `VT${String(100000 + i).slice(1)}`,
                    state: states[Math.floor(Math.random() * states.length)],
                    gender: genders[Math.floor(Math.random() * genders.length)],
                    age_range: ageRanges[Math.floor(Math.random() * ageRanges.length)],
                    party_affiliation: parties[Math.floor(Math.random() * parties.length)],
                    ethnicity: ethnicities[Math.floor(Math.random() * ethnicities.length)],
                    education_level: education[Math.floor(Math.random() * education.length)],
                    income_bracket: income[Math.floor(Math.random() * income.length)],
                    has_cell_phone: Math.random() > 0.15 ? 'Yes' : 'No',
                    has_landline: Math.random() > 0.6 ? 'Yes' : 'No',
                    registered_voter: Math.random() > 0.1 ? 'Yes' : 'No',
                    veteran_status: Math.random() > 0.85 ? 'Yes' : 'No',
                    employment_status: Math.random() > 0.25 ? 'Employed' : 'Unemployed',
                    urban_rural: Math.random() > 0.4 ? 'Urban' : 'Rural'
                });
            }
            
            return data;
        }

        // Initialize dashboard
        function initDashboard() {
            if (isInitialized) return;
            
            // Set up event listeners
            document.getElementById('csvFile').addEventListener('change', handleFileUpload);
            document.getElementById('customizeBtn').addEventListener('click', function() {
                const panel = document.getElementById('customizePanel');
                panel.classList.toggle('show');
            });
            document.getElementById('closeCustomizeBtn').addEventListener('click', function() {
                document.getElementById('customizePanel').classList.remove('show');
            });
            document.getElementById('addChartBtn').addEventListener('click', addChart);
            document.getElementById('exportBtn').addEventListener('click', exportToPDF);
            document.getElementById('exportDataBtn').addEventListener('click', exportFilteredData);
            document.getElementById('clearFiltersBtn').addEventListener('click', clearAllFilters);
            
            // Title editing
            document.getElementById('titleInput').addEventListener('blur', saveTitle);
            document.getElementById('titleInput').addEventListener('keypress', handleTitleKeypress);
            
            // Load sample data for demonstration
            currentData = generateSampleData();
            filteredData = [...currentData];
            
            dataQuality = analyzeDataQuality(currentData);
            updateDataQualityDisplay();
            
            const detectedFields = detectFields(currentData);
            availableFields = detectedFields.categorical;
            
            chartConfigs = generateDefaultChartConfigs(availableFields);
            
            createAdvancedFilters();
            updateCustomizationPanel();
            updateDashboard();
            
            document.getElementById('status').textContent = 'Ready - Enhanced sample data loaded';
            showMessage('Demo dashboard loaded with enhanced sample data. Upload your own CSV file to analyze your data!', 'info', 4000);
            
            isInitialized = true;
        }

        // Make functions globally available
        window.updateChartConfig = updateChartConfig;
        window.removeChart = removeChart;
        window.editTitle = editTitle;
        window.saveTitle = saveTitle;
        window.handleTitleKeypress = handleTitleKeypress;
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>
</html>
